<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connexion | CRG Services</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:#0a0a0a;
    color:#fff;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow-x:hidden
}
body::before{
    content:'';
    position:fixed;
    inset:0;
    background:repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,102,255,.03) 2px,
        rgba(0,102,255,.03) 4px
    );
    pointer-events:none
}
.login-container{
    background:rgba(10,10,10,.95);
    backdrop-filter:blur(10px);
    border:2px solid #0066ff;
    border-radius:20px;
    padding:3rem;
    width:90%;
    max-width:500px;
    box-shadow:0 0 50px rgba(0,102,255,.5);
    z-index:1
}
.logo{text-align:center;margin-bottom:2rem}
.logo h1{
    font-size:2.5rem;
    color:#0066ff;
    text-shadow:0 0 20px #0066ff,0 0 40px #0066ff;
    animation:neonPulse 2s infinite
}
@keyframes neonPulse{
    0%,100%{text-shadow:0 0 10px #0066ff}
    50%{text-shadow:0 0 30px #0066ff}
}
.tabs{display:flex;gap:1rem;margin-bottom:2rem}
.tab{
    flex:1;
    padding:1rem;
    border:2px solid rgba(0,102,255,.3);
    background:transparent;
    color:#0066ff;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold
}
.tab.active{background:#0066ff;color:#000}
.form-section{display:none}
.form-section.active{display:block}
.input-group{margin-bottom:1.5rem}
.input-group label{color:#0066ff;font-weight:bold;display:block;margin-bottom:.5rem}
.input-group input{
    width:100%;
    padding:1rem;
    background:rgba(0,102,255,.1);
    border:2px solid rgba(0,102,255,.3);
    border-radius:10px;
    color:#fff
}
.submit-btn{
    width:100%;
    padding:1rem;
    background:#0066ff;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer
}
.divider{text-align:center;margin:2rem 0;color:#666}
.social-login{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.social-btn{
    padding:1rem;
    border:2px solid rgba(0,102,255,.3);
    background:rgba(0,102,255,.1);
    color:#0066ff;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer
}
.error-message,.success-message{
    padding:1rem;
    border-radius:10px;
    margin-bottom:1rem;
    display:none
}
.error-message{color:#ff6b6b;border:2px solid rgba(255,0,0,.5)}
.success-message{color:#51cf66;border:2px solid rgba(0,255,0,.5)}
.show{display:block}
.footer-links{text-align:center;margin-top:2rem;color:#666}
.footer-links a{color:#0066ff;text-decoration:none}
</style>
</head>

<body>

<div class="login-container">

<div class="logo">
<h1>CRG SERVICES</h1>
<p>Acc√©dez √† votre espace</p>
</div>

<div class="error-message" id="errorMessage"></div>
<div class="success-message" id="successMessage"></div>

<div class="tabs">
<button class="tab active" onclick="switchTab('email', this)">Email</button>
<button class="tab" onclick="switchTab('phone', this)">T√©l√©phone</button>
</div>

<!-- EMAIL -->
<div class="form-section active" id="emailSection">
<form onsubmit="loginWithEmail(event)">
<div class="input-group">
<label>Email</label>
<input type="email" id="emailInput" required>
</div>
<div class="input-group">
<label>Mot de passe</label>
<input type="password" id="passwordInput" required>
</div>
<button class="submit-btn">SE CONNECTER</button>
</form>
</div>

<!-- PHONE -->
<div class="form-section" id="phoneSection">
<form onsubmit="loginWithPhone(event)">
<div class="input-group">
<label>T√©l√©phone</label>
<input type="tel" id="phoneInput" placeholder="+33612345678" required>
</div>
<div id="recaptcha-container"></div>
<button class="submit-btn">ENVOYER LE CODE</button>

<div id="codeSection" style="display:none;margin-top:1rem">
<div class="input-group">
<label>Code SMS</label>
<input id="codeInput">
</div>
<button type="button" onclick="verifyCode()" class="submit-btn">V√âRIFIER</button>
</div>
</form>
</div>

<div class="divider">OU</div>

<div class="social-login">
<button class="social-btn" onclick="loginWithGoogle()">Google</button>
<button class="social-btn" onclick="loginWithDiscord()">Discord</button>
</div>

<div class="footer-links">
<p>Pas encore de compte ? <a href="register.html">S'inscrire</a></p>
<p><a href="index.html">‚Üê Accueil</a></p>
</div>

</div>

<!-- FIREBASE SDK (ORDRE CRITIQUE) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- CONFIG FIREBASE -->
<script src="/firebase.config.js"></script>

<script>
let confirmationResult = null;

/* üîê S√âCURIT√â : Firebase doit exister */
if (typeof firebaseAuth === "undefined") {
    alert("‚ùå Firebase non initialis√©. V√©rifie firebase.config.js");
}

/* UI */
function switchTab(tab, btn){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tab+'Section').classList.add('active');
}

function showError(msg){
    errorMessage.textContent = msg;
    errorMessage.classList.add('show');
    setTimeout(()=>errorMessage.classList.remove('show'),4000);
}

function showSuccess(msg){
    successMessage.textContent = msg;
    successMessage.classList.add('show');
}

/* EMAIL */
async function loginWithEmail(e){
    e.preventDefault();
    try{
        const cred = await firebaseAuth.signInWithEmailAndPassword(
            emailInput.value,
            passwordInput.value
        );
        if (window.sendDiscordLog) {
            await sendDiscordLog('login', cred.user, {provider:'Email'});
        }
        showSuccess("Connexion r√©ussie");
        setTimeout(()=>location.href="index.html",1200);
    }catch{
        showError("Identifiants invalides");
    }
}

/* GOOGLE */
async function loginWithGoogle(){
    try{
        const provider = new firebase.auth.GoogleAuthProvider();
        const r = await firebaseAuth.signInWithPopup(provider);
        if (window.sendDiscordLog) {
            await sendDiscordLog('login', r.user, {provider:'Google'});
        }
        location.href="index.html";
    }catch{
        showError("Erreur Google");
    }
}

/* DISCORD */
function loginWithDiscord(){
    showError("Discord n√©cessite un backend (OAuth)");
}

/* PHONE */
function loginWithPhone(e){
    e.preventDefault();
    window.recaptchaVerifier =
        new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'normal'});
    firebaseAuth.signInWithPhoneNumber(phoneInput.value, recaptchaVerifier)
    .then(r=>{
        confirmationResult = r;
        codeSection.style.display="block";
    })
    .catch(()=>showError("Erreur SMS"));
}

async function verifyCode(){
    try{
        const r = await confirmationResult.confirm(codeInput.value);
        if (window.sendDiscordLog) {
            await sendDiscordLog('login', r.user, {provider:'Phone'});
        }
        location.href="index.html";
    }catch{
        showError("Code invalide");
    }
}

/* AUTO REDIRECT */
firebaseAuth.onAuthStateChanged(user=>{
    if(user){
        location.href="index.html";
    }
});
</script>

</body>
</html>
