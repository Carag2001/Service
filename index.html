<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin | CRG Services</title>

    <!-- ===== CSS DASHBOARD ===== -->
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>

<div class="dashboard-container">

    <!-- ================= SIDEBAR ================= -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>ğŸ® CRG SERVICES</h2>
            <p>Dashboard Admin</p>
        </div>

        <nav class="sidebar-nav">
            <a href="manager.html" class="nav-item active">
                <span>ğŸ“Š</span> Vue d'ensemble
            </a>
            <a href="recrutement.html" class="nav-item">
                <span>âš™ï¸</span> Services
            </a>
            <a href="#" class="nav-item">
                <span>ğŸ“…</span> Agenda
            </a>
            <a href="#" class="nav-item">
                <span>ğŸ‘¥</span> Utilisateurs
            </a>
            <a href="#" class="nav-item">
                <span>ğŸ“ˆ</span> Statistiques
            </a>
            <a href="#" class="nav-item">
                <span>ğŸ”§</span> ParamÃ¨tres
            </a>
        </nav>

        <div class="sidebar-footer">
            <button onclick="backToSite()" class="btn-secondary">
                â† Retour au site
            </button>
            <button onclick="logout()" class="btn-danger">
                ğŸšª DÃ©connexion
            </button>
        </div>
    </aside>

    <!-- ================= MAIN ================= -->
    <main class="main-content">

        <!-- ===== HEADER ===== -->
        <header class="content-header">
            <div>
                <h1>ğŸ“Š Vue d'ensemble</h1>
                <p>Bienvenue sur le dashboard admin</p>
            </div>

            <div class="user-info">
                <span id="adminName">Admin</span>
                <div class="user-avatar">ğŸ‘¤</div>
            </div>
        </header>

        <!-- ===== ACCÃˆS REFUSÃ‰ ===== -->
        <div id="accessDenied" class="access-denied" style="display:none;">
            <h2>ğŸš« AccÃ¨s refusÃ©</h2>
            <p>Vous n'avez pas les permissions nÃ©cessaires.</p>
            <button onclick="backToSite()" class="btn-primary">
                Retour au site
            </button>
        </div>

        <!-- ===== CONTENU DASHBOARD ===== -->
        <div id="dashboardContent" style="display:none;">

            <!-- ===== STATS ===== -->
            <div class="stats-grid">

                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>Utilisateurs</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘€</div>
                    <div class="stat-info">
                        <h3 id="totalVisits">0</h3>
                        <p>Visites aujourd'hui</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">âš™ï¸</div>
                    <div class="stat-info">
                        <h3 id="totalServices">0</h3>
                        <p>Services actifs</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-info">
                        <h3 id="totalAppointments">0</h3>
                        <p>Rendez-vous</p>
                    </div>
                </div>

            </div>

            <!-- ===== ACTIVITÃ‰S ===== -->
            <div class="section">
                <h2>ğŸ“‹ ActivitÃ©s rÃ©centes</h2>
                <div class="activity-list" id="activityList">
                    <p style="opacity:.6">Chargement...</p>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script src="firebase.config.js"></script>
<script src="dashboard.js"></script>
<script src="protect.site.js"></script>

<script>
/* ================= AUTH & PERMISSIONS ================= */

firebaseAuth.onAuthStateChanged(async (user) => {

    if (!user) {
        window.location.href = "login.html";
        return;
    }

    document.getElementById("adminName").textContent =
        user.displayName || user.email || "Admin";

    const admin = await isAdmin(user);

    if (!admin) {
        document.getElementById("accessDenied").style.display = "flex";
        document.getElementById("dashboardContent").style.display = "none";
        return;
    }

    document.getElementById("accessDenied").style.display = "none";
    document.getElementById("dashboardContent").style.display = "block";

    loadDashboardStats();
    loadRecentActivity();
});

/* ================= STATS ================= */

async function loadDashboardStats() {
    try {
        const users = await firebaseDb.collection("users").get();
        document.getElementById("totalUsers").textContent = users.size;

        const visits = await firebaseDb.collection("visits").get();
        document.getElementById("totalVisits").textContent = visits.size;

        const services = await firebaseDb.collection("services").get();
        document.getElementById("totalServices").textContent = services.size;

        const appointments = await firebaseDb.collection("appointments").get();
        document.getElementById("totalAppointments").textContent = appointments.size;

    } catch (e) {
        console.error("Erreur stats :", e);
    }
}

/* ================= ACTIVITÃ‰S ================= */

async function loadRecentActivity() {
    const list = document.getElementById("activityList");
    list.innerHTML = "";

    try {
        const logs = await firebaseDb
            .collection("logs")
            .orderBy("timestamp", "desc")
            .limit(10)
            .get();

        if (logs.empty) {
            list.innerHTML = "<p>Aucune activitÃ© rÃ©cente</p>";
            return;
        }

        logs.forEach(doc => {
            const log = doc.data();
            const div = document.createElement("div");
            div.className = "activity-item";

            const date = log.timestamp?.toDate().toLocaleString("fr-FR");

            div.innerHTML = `
                <strong>${log.action || "Action"}</strong>
                <br>
                <small>${log.userEmail || "Utilisateur"} â€¢ ${date}</small>
            `;
            list.appendChild(div);
        });

    } catch (e) {
        list.innerHTML = "<p>Erreur de chargement</p>";
        console.error(e);
    }
}

/* ================= NAV ================= */

function backToSite() {
    window.location.href = "index.html";
}

async function logout() {
    await firebaseAuth.signOut();
    window.location.href = "login.html";
}
</script>

</body>
</html>
